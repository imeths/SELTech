<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELTech Solar Package Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF LIBRARIES -->
    <!-- jsPDF (for CREATING the new page) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- NEW: pdf-lib (for LOADING and MERGING existing PDFs) -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>


    <style>
        /* Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom spinner for download button */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Custom styles for active/inactive tabs */
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        
        .tab-btn {
            border-bottom: 2px solid transparent;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden" style="min-height: 500px;">
        <!-- Header Section -->
        <header class="p-6 bg-gradient-to-r from-blue-700 to-blue-900 text-white">
            <!-- Logo added to the main page header -->
            <img src="https://i.postimg.cc/KvgCmtJG/SELTech-Logo-App.png" alt="SELTech Logo" class="w-20 h-20 mx-auto rounded-md shadow-lg">
            
            <h1 class="text-3xl font-bold text-center mt-4">SELTech International</h1>
            <p class="text-center text-blue-200 mt-1">Solar Package Calculator</p>
        </header>

        <!-- Search Section -->
        <section id="budgetSection" class="p-6 md:p-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5 text-center">Find Your Perfect Solar Package</h2>
            
            <!-- Tab Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button id="budgetTabBtn" class="tab-btn active w-1/2 py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Search by Budget
                    </button>
                    <button id="kwTabBtn" class="tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Search by Size (kW)
                    </button>
                </nav>
            </div>
            
            <!-- Tab Content -->
            <div>
                <!-- Budget Range Tab Content -->
                <div id="budgetTabContent">
                    <fieldset class="space-y-4">
                        <legend class="sr-only">Budget Range</legend>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="range-700k" name="budgetRange" type="radio" value="700000" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="range-700k" class="font-medium text-gray-700">Under 700,000</label>
                            </div>
                        </div>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="range-900k" name="budgetRange" type="radio" value="900000" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="range-900k" class="font-medium text-gray-700">Under 900,000</label>
                            </div>
                        </div>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="range-1400k" name="budgetRange" type="radio" value="1400000" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="range-1400k" class="font-medium text-gray-700">Under 1,400,000</label>
                            </div>
                        </div>
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5">
                                <input id="range-all" name="budgetRange" type="radio" value="all" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="range-all" class="font-medium text-gray-700">Show All Packages</label>
                            </div>
                        </div>
                    </fieldset>
                    <button id="findPackagesByBudgetBtn"
                        class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Find Packages
                    </button>
                </div>
                
                <!-- kW Size Tab Content (Hidden by default) -->
                <div id="kwTabContent" class="hidden">
                    <label for="kwSelect" class="block text-sm font-medium text-gray-700">Select System Size</label>
                    <select id="kwSelect" name="kwSelect" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Show All Sizes</option>
                        <option value="3.3">3.3 kW</option>
                        <option value="5">5 kW</option>
                    </select>
                    <button id="findPackagesByKwBtn"
                        class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Find Packages
                    </button>
                </div>
            </div>
        </section>

        <!-- Packages List Section -->
        <section id="packagesSection" class="p-6 md:p-8 hidden">
            <h2 id="packagesTitle" class="text-2xl font-semibold text-gray-800 mb-5 text-center">Available Packages</h2>
            <div id="packagesList" class="space-y-4">
                <!-- Package cards will be injected here by JavaScript -->
            </div>
            <div id="noPackagesMessage" class="text-center text-gray-500 py-8 hidden">
                <p class="text-lg">No packages found for your selection.</p>
                <p class="text-sm">Please try a different range or system size.</p>
            </div>
            <button id="startOverBtn"
                class="w-full mt-6 bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                Start Over
            </button>
        </section>

        <!-- Package Details Section -->
        <section id="detailsSection" class="p-6 md:p-8 hidden">
            <!-- Details will be injected here -->
            <div id="packageDetailContent">
                <h2 id="detail-name" class="text-3xl font-bold text-gray-900 text-center">Package Name</h2>
                <p id="detail-price" class="text-2xl font-semibold text-blue-700 text-center mt-2">Price</p>

                <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3 border-b pb-2">What's Included:</h3>
                <ul id="detail-products" class="list-disc list-inside text-gray-700 space-y-1">
                    <!-- Product items will be injected here by JavaScript -->
                </ul>
            </div>
            
            <form id="pdfForm" class="mt-6 mb-4 space-y-3" novalidate>
                <h3 class="text-lg font-semibold text-gray-800">Personalize Your Quotation (Required)</h3>
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="customerName" name="customerName" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., John Doe" required>
                    <span id="nameError" class="text-red-600 text-sm hidden mt-1">This field is required.</span>
                </div>
                <div>
                    <label for="customerAddress" class="block text-sm font-medium text-gray-700">Your Address</label>
                    <textarea id="customerAddress" name="customerAddress" rows="2" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 123 Main St, Colombo" required></textarea>
                    <span id="addressError" class="text-red-600 text-sm hidden mt-1">This field is required.</span>
                </div>
                <div>
                    <label for="customerDiscount" class="block text-sm font-medium text-gray-700">Discount Percentage (Optional)</label>
                    <input type="number" id="customerDiscount" name="customerDiscount" min="0" max="100" step="0.1" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 5">
                </div>
            
                <!-- Action Buttons for Details View -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4">
                    <button id="downloadPdfBtn" type="submit"
                            class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center justify-center gap-2">
                        <span id="downloadBtnText">Download as PDF</span>
                        <div id="downloadSpinner" class="spinner hidden"></div>
                    </button>
                    <button id="backBtn" type="button"
                            class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                        Back to List
                    </button>
                </div>
            </form>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Database of Solar Packages ---
            const allPackages = [
                {
                    id: 1,
                    name: '3.3kW Chinese Package',
                    price: 600000,
                    kw: 3.3,
                    brand: 'Chinese',
                    products: [
                        '10 x 330W Solar Panels (Chinese)',
                        '1 x 3.3kW On-Grid Inverter (Chinese)',
                        'Standard Mounting Structure',
                        'DC/AC Cabling & Accessories',
                        'Installation & Commissioning'
                    ]
                },
                {
                    id: 2,
                    name: '3.3kW Korean Package',
                    price: 850000,
                    kw: 3.3,
                    brand: 'Korean',
                    products: [
                        '8 x 415W Solar Panels (Korean Brand)',
                        '1 x 3.3kW On-Grid Inverter (Korean Brand)',
                        'Premium Mounting Structure',
                        'DC/AC Cabling & Accessories',
                        'Installation & Commissioning'
                    ]
                },
                {
                    id: 3,
                    name: '5kW Chinese Package',
                    price: 900000,
                    kw: 5,
                    brand: 'Chinese',
                    products: [
                        '15 x 330W Solar Panels (Chinese)',
                        '1 x 5kW On-Grid Inverter (Chinese)',
                        'Standard Mounting Structure',
                        'DC/AC Cabling & Accessories',
                        'Installation & Commissioning'
                    ]
                },
                {
                    id: 4,
                    name: '5kW Korean Package',
                    price: 1300000,
                    kw: 5,
                    brand: 'Korean',
                    products: [
                        '12 x 415W Solar Panels (Korean Brand)',
                        '1 x 5kW On-Grid Inverter (Korean Brand)',
                        'Premium Mounting Structure',
                        'DC/AC Cabling & Accessories',
                        'Installation & Commissioning'
                    ]
                }
            ];
            // --- End of Package Database ---


            // --- UI Sections ---
            const budgetSection = document.getElementById('budgetSection');
            const packagesSection = document.getElementById('packagesSection');
            const detailsSection = document.getElementById('detailsSection');

            // --- Buttons ---
            const findPackagesByBudgetBtn = document.getElementById('findPackagesByBudgetBtn');
            const findPackagesByKwBtn = document.getElementById('findPackagesByKwBtn');
            const startOverBtn = document.getElementById('startOverBtn');
            const backBtn = document.getElementById('backBtn');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const downloadBtnText = document.getElementById('downloadBtnText');
            const downloadSpinner = document.getElementById('downloadSpinner');

            // --- Inputs & Validation ---
            const customerNameInput = document.getElementById('customerName');
            const customerAddressInput = document.getElementById('customerAddress');
            const pdfForm = document.getElementById('pdfForm');
            const nameError = document.getElementById('nameError');
            const addressError = document.getElementById('addressError');
            
            // --- State ---
            let currentSelectedPackage = null;
            
            // --- Tabs ---
            const budgetTabBtn = document.getElementById('budgetTabBtn');
            const kwTabBtn = document.getElementById('kwTabBtn');
            const budgetTabContent = document.getElementById('budgetTabContent');
            const kwTabContent = document.getElementById('kwTabContent');
            
            // --- Lists & Details ---
            const packagesList = document.getElementById('packagesList');
            const packagesTitle = document.getElementById('packagesTitle');
            const noPackagesMessage = document.getElementById('noPackagesMessage');
            const detailName = document.getElementById('detail-name');
            const detailPrice = document.getElementById('detail-price');
            const detailProducts = document.getElementById('detail-products');
            const kwSelect = document.getElementById('kwSelect');


            // --- Tab Navigation Logic ---
            budgetTabBtn.addEventListener('click', () => {
                budgetTabBtn.classList.add('active');
                kwTabBtn.classList.remove('active');
                budgetTabContent.classList.remove('hidden');
                kwTabContent.classList.add('hidden');
            });
            
            kwTabBtn.addEventListener('click', () => {
                kwTabBtn.classList.add('active');
                budgetTabBtn.classList.remove('active');
                kwTabContent.classList.remove('hidden');
                budgetTabContent.classList.add('hidden');
            });

            // --- Filter Functions ---
            function findPackagesByBudget() {
                const selectedRange = document.querySelector('input[name="budgetRange"]:checked').value;
                let filteredPackages;
                if (selectedRange === 'all') {
                    filteredPackages = allPackages;
                } else {
                    const maxBudget = parseInt(selectedRange, 10);
                    filteredPackages = allPackages.filter(pkg => pkg.price <= maxBudget);
                }
                displayPackages(filteredPackages);
            }

            function findPackagesByKw() {
                const selectedKw = kwSelect.value;
                let filteredPackages;
                if (selectedKw === 'all') {
                    filteredPackages = allPackages;
                } else {
                    const kw = parseFloat(selectedKw);
                    filteredPackages = allPackages.filter(pkg => pkg.kw === kw);
                }
                displayPackages(filteredPackages);
            }

            // --- UI Display Functions ---
            function displayPackages(packages) {
                packagesList.innerHTML = ''; 
                if (packages.length === 0) {
                    noPackagesMessage.classList.remove('hidden');
                } else {
                    noPackagesMessage.classList.add('hidden');
                    packages.sort((a, b) => a.price - b.price);
                    packages.forEach(pkg => {
                        const card = document.createElement('div');
                        card.className = 'border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-lg transition-shadow duration-300';
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">${pkg.name}</h3>
                                    <p class="text-lg font-medium text-blue-700 mt-1">${pkg.price.toLocaleString()}</p>
                                </div>
                                <button data-id="${pkg.id}" class="view-details-btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                    View Details
                                </button>
                            </div>
                        `;
                        packagesList.appendChild(card);
                    });
                }

                document.querySelectorAll('.view-details-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const packageId = parseInt(e.target.dataset.id, 10);
                        showPackageDetails(packageId);
                    });
                });

                budgetSection.classList.add('hidden');
                detailsSection.classList.add('hidden');
                packagesSection.classList.remove('hidden');
            }

            function showPackageDetails(packageId) {
                currentSelectedPackage = allPackages.find(pkg => pkg.id === packageId);
                if (!currentSelectedPackage) return;
                detailName.textContent = currentSelectedPackage.name;
                detailPrice.textContent = `${currentSelectedPackage.price.toLocaleString()}`;
                detailProducts.innerHTML = '';
                currentSelectedPackage.products.forEach(product => {
                    const li = document.createElement('li');
                    li.textContent = product;
                    detailProducts.appendChild(li);
                });
                packagesSection.classList.add('hidden');
                detailsSection.classList.remove('hidden');
            }
            
            function showPackageList() {
                detailsSection.classList.add('hidden');
                packagesSection.classList.remove('hidden');
                currentSelectedPackage = null;
                nameError.classList.add('hidden');
                addressError.classList.add('hidden');
            }

            function showBudgetInput() {
                detailsSection.classList.add('hidden');
                packagesSection.classList.add('hidden');
                budgetSection.classList.remove('hidden');
                kwSelect.value = 'all';
                document.getElementById('range-all').checked = true;
                customerNameInput.value = '';
                customerAddressInput.value = '';
                nameError.classList.add('hidden');
                addressError.classList.add('hidden');
                document.getElementById('customerDiscount').value = '';
                budgetTabBtn.click();
            }
            
            // --- PDF Generation Logic ---
            
            // Helper function to download bytes as a file
            function downloadBlob(bytes, fileName, mimeType) {
                const blob = new Blob([bytes], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }

            // Main handler for form submission
            async function handlePdfGeneration(event) {
                event.preventDefault(); 
                nameError.classList.add('hidden');
                addressError.classList.add('hidden');
                let isValid = true;
                
                const customerName = customerNameInput.value.trim();
                const customerAddress = customerAddressInput.value.trim();
                
                if (customerName === '') {
                    nameError.classList.remove('hidden');
                    isValid = false;
                }
                if (customerAddress === '') {
                    addressError.classList.remove('hidden');
                    isValid = false;
                }
                
                const discountInput = document.getElementById('customerDiscount').value;
                const discountPercentage = parseFloat(discountInput) || 0; // Treat empty/invalid as 0

                if (!isValid || !currentSelectedPackage) {
                    return;
                }

                // Show loading state
                downloadBtnText.textContent = 'Generating...';
                downloadSpinner.classList.remove('hidden');
                downloadPdfBtn.disabled = true;

                // UPDATED: Use a relative path. 
                // This assumes 'SELTech Quotation.pdf' is in the SAME folder as index.html on Vercel.
                const templateUrl = './SELTech Quotation.pdf';
                
                try {
                    // Load the PDF-LIB functions
                    const { PDFDocument } = window.PDFLib;

                    // 1. Create our new quote page in memory
                    const quotePageBytes = await createQuotePage(customerName, customerAddress, discountPercentage);

                    // 2. Fetch your existing PDF template
                    const templateBytes = await fetch(templateUrl).then(res => {
                        if (!res.ok) {
                            throw new Error(`Failed to fetch PDF template (Status: ${res.status}). Ensure 'SELTech Quotation.pdf' is in your project folder.`);
                        }
                        return res.arrayBuffer();
                    });

                    // 3. Create a new, blank PDF document
                    const finalPdfDoc = await PDFDocument.create();

                    // 4. Load the template and our new quote
                    const templateDoc = await PDFDocument.load(templateBytes);
                    const quoteDoc = await PDFDocument.load(quotePageBytes);

                    // 5. Copy pages 1-6 from the template
                    const templatePageIndices1 = [0, 1, 2, 3, 4, 5]; // Pages 1-6
                    const copiedPages1 = await finalPdfDoc.copyPages(templateDoc, templatePageIndices1);
                    copiedPages1.forEach(page => finalPdfDoc.addPage(page));

                    // 6. Copy our new quote page (it's the only page, so index 0)
                    const [newQuotePage] = await finalPdfDoc.copyPages(quoteDoc, [0]);
                    finalPdfDoc.addPage(newQuotePage); // This is now Page 7

                    // 7. Copy pages 7-10 from the template
                    const templatePageIndices2 = [6, 7, 8, 9]; // Pages 7-10
                    const copiedPages2 = await finalPdfDoc.copyPages(templateDoc, templatePageIndices2);
                    copiedPages2.forEach(page => finalPdfDoc.addPage(page));

                    // 8. Save the final merged PDF
                    const finalPdfBytes = await finalPdfDoc.save();

                    // 9. Trigger the download
                    const fileName = `SELTech_Quotation_${currentSelectedPackage.name.replace(/ /g, '_')}.pdf`;
                    downloadBlob(finalPdfBytes, fileName, 'application/pdf');

                } catch (error) {
                    console.error("Error generating merged PDF:", error);
                    downloadBtnText.textContent = 'Error! Try Again.';
                    // Don't use alert()
                    // alert('Failed to generate PDF. Please check your internet connection and try again.');
                } finally {
                    // Reset button state
                    // Keep the error message if it failed, otherwise reset
                    if (downloadBtnText.textContent.includes('Error')) {
                         setTimeout(() => {
                            downloadBtnText.textContent = 'Download as PDF';
                            downloadSpinner.classList.add('hidden');
                            downloadPdfBtn.disabled = false;
                         }, 3000); // Reset after 3 seconds
                    } else {
                        downloadBtnText.textContent = 'Download as PDF';
                        downloadSpinner.classList.add('hidden');
                        downloadPdfBtn.disabled = false;
                    }
                }
            }
            
            // This function creates the new PDF page in memory
            async function createQuotePage(customerName, customerAddress, discountPercentage) {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const pageMargin = 20;
                let yPos = pageMargin;

                // 1. Add Logo (from URL)
                const logoUrl = 'https://i.postimg.cc/KvgCmtJG/SELTech-Logo-App.png';
                try {
                    // addImage handles URLs. We keep the try/catch in case of network/CORS failure.
                    pdf.addImage(logoUrl, 'PNG', pageMargin, yPos, 30, 30);
                } catch (imgError) {
                    console.error("Error adding logo to PDF:", imgError);
                    pdf.setFillColor(230, 230, 230);
                    pdf.rect(pageMargin, yPos, 30, 30, 'F');
                    pdf.setTextColor(150, 150, 150);
                    pdf.setFontSize(10);
                    pdf.text('Logo Load Failed', pageMargin + 15, yPos + 16, { align: 'center' });
                }

                // 2. Add Company Info
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(80, 80, 80);
                pdf.text('SELTech International', pageWidth - pageMargin, yPos + 5, { align: 'right' });
                pdf.text('30, Pepiliyana Rd, Nugegoda', pageWidth - pageMargin, yPos + 10, { align: 'right' });
                pdf.text('011 273 9933 / 077 731 5605', pageWidth - pageMargin, yPos + 15, { align: 'right' });
                
                // 3. Add Customer Details
                yPos = 60;
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(80, 80, 80);
                pdf.text('PREPARED FOR:', pageMargin, yPos);
                
                yPos += 6;
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(20, 20, 20);
                pdf.text(customerName, pageMargin, yPos);
                
                yPos += 6;
                const addressLines = pdf.splitTextToSize(customerAddress, 80);
                pdf.text(addressLines, pageMargin, yPos);
                yPos += (addressLines.length * 6) + 10;

                // 4. Add Title & Date
                pdf.setFontSize(22);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(30, 58, 138); // Dark Blue
                pdf.text('Solar Package Quotation', pageMargin, yPos);
                
                yPos += 8;
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(50, 50, 50);
                const date = new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                pdf.text(`Date Issued: ${date}`, pageMargin, yPos);

                yPos += 15;

                // 5. Add Package Details Box
                let boxContentHeight = 22; // Initial padding and name/size lines
                
                // Add lines for price, discount, and total
                const originalPrice = currentSelectedPackage.price;
                let discountAmount = 0;
                let finalPrice = originalPrice;
                
                const priceLines = [];
                priceLines.push({ label: 'Package Price:', value: originalPrice.toLocaleString() });
                
                if (discountPercentage > 0) {
                    discountAmount = (originalPrice * discountPercentage) / 100;
                    finalPrice = originalPrice - discountAmount;
                    
                    priceLines.push({ label: `Discount (${discountPercentage}%):`, value: `- ${discountAmount.toLocaleString()}` });
                    priceLines.push({ label: 'Final Price:', value: finalPrice.toLocaleString(), isBold: true });
                    
                    boxContentHeight += (priceLines.length - 1) * 7; // Add height for extra lines
                } else {
                    // No discount, just show total
                    priceLines.push({ label: 'Total Price:', value: finalPrice.toLocaleString(), isBold: true });
                    boxContentHeight += 7;
                }
                
                // Recalculate box height
                const boxHeight = boxContentHeight + 10; // Add some final padding
                
                pdf.setFillColor(249, 250, 251); // gray-50
                pdf.setDrawColor(229, 231, 235); // gray-200
                pdf.roundedRect(pageMargin, yPos, pageWidth - (pageMargin * 2), boxHeight, 3, 3, 'FD');
                
                // Package Name and Size
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(20, 20, 20);
                pdf.text(currentSelectedPackage.name, pageMargin + 10, yPos + 10);
                
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(80, 80, 80);
                pdf.text(`System Size: ${currentSelectedPackage.kw} kW`, pageMargin + 10, yPos + 18);
                
                // --- Price details on the right side ---
                let priceYPos = yPos + 10;
                const priceXLabel = pageWidth - pageMargin - 65; // X position for labels
                const priceXValue = pageWidth - pageMargin - 10; // X position for values

                priceLines.forEach((line, index) => {
                    if (line.isBold) {
                        pdf.setFontSize(14); // Make final price larger
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(30, 58, 138); // Dark Blue
                    } else {
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(80, 80, 80);
                    }
                    
                    pdf.text(line.label, priceXLabel, priceYPos, { align: 'left' });
                    pdf.text(line.value, priceXValue, priceYPos, { align: 'right' });
                    
                    priceYPos += 7; // Spacing for each line
                });

                // Reset font
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');

                yPos += boxHeight + 10; // Move yPos down past the box
                
                // 6. Add Products Table
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(50, 50, 50);
                pdf.text('Products Included', pageMargin, yPos);
                
                yPos += 8;
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(20, 20, 20);
                
                const lineHeight = 6;
                
                currentSelectedPackage.products.forEach((product, index) => {
                    // Check if we need to add a new page
                    if (yPos + lineHeight > pageHeight - pageMargin) {
                        pdf.addPage();
                        yPos = pageMargin;
                        // Reset font settings for new page
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'normal');
                    }
                    pdf.text('â€¢', pageMargin + 5, yPos);
                    const productLines = pdf.splitTextToSize(product, pageWidth - (pageMargin * 2) - 15);
                    pdf.text(productLines, pageMargin + 10, yPos);
                    yPos += (productLines.length * lineHeight) + 2; // Add a little padding
                });

                // 7. Add Footer
                const footerY = pdf.internal.pageSize.getHeight() - 15;
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(150, 150, 150);
                pdf.line(pageMargin, footerY - 5, pageWidth - pageMargin, footerY - 5);
                pdf.text('This is a dynamically generated quotation page.', pageWidth / 2, footerY, { align: 'center' });
                
                // 8. Return the PDF bytes
                return pdf.output('arraybuffer');
            }

            // --- Attach Initial Event Listeners ---
            findPackagesByBudgetBtn.addEventListener('click', findPackagesByBudget);
            findPackagesByKwBtn.addEventListener('click', findPackagesByKw);
            startOverBtn.addEventListener('click', showBudgetInput);
            backBtn.addEventListener('click', showPackageList);
            pdfForm.addEventListener('submit', handlePdfGeneration);
            
            // Set default tab on load
            budgetTabBtn.click();
        });
    </script>
</body>
</html>