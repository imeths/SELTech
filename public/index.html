<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELTech Solar Package Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px; height: 20px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .tab-btn { border-bottom: 2px solid transparent; }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden" style="min-height: 500px;">
        <header class="p-6 bg-gradient-to-r from-blue-700 to-blue-900 text-white">
            <img src="https://i.postimg.cc/KvgCmtJG/SELTech-Logo-App.png" alt="SELTech Logo" class="w-20 h-20 mx-auto rounded-md shadow-lg">
            <h1 class="text-3xl font-bold text-center mt-4">SELTech International</h1>
            <p class="text-center text-blue-200 mt-1">Solar Package Calculator</p>
        </header>

        <!-- Search Section -->
        <section id="budgetSection" class="p-6 md:p-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5 text-center">Find Your Perfect Solar Package</h2>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button id="budgetTabBtn" class="tab-btn active w-1/2 py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Search by Budget</button>
                    <button id="kwTabBtn" class="tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Search by Size (kW)</button>
                </nav>
            </div>
            <div>
                <div id="budgetTabContent">
                    <fieldset class="space-y-4">
                        <legend class="sr-only">Budget Range</legend>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="range-700k" name="budgetRange" type="radio" value="700000" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300"></div><div class="ml-3 text-sm"><label for="range-700k" class="font-medium text-gray-700">Under 700,000</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="range-900k" name="budgetRange" type="radio" value="900000" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300"></div><div class="ml-3 text-sm"><label for="range-900k" class="font-medium text-gray-700">Under 900,000</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="range-1400k" name="budgetRange" type="radio" value="1400000" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300"></div><div class="ml-3 text-sm"><label for="range-1400k" class="font-medium text-gray-700">Under 1,400,000</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="range-all" name="budgetRange" type="radio" value="all" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked></div><div class="ml-3 text-sm"><label for="range-all" class="font-medium text-gray-700">Show All Packages</label></div></div>
                    </fieldset>
                    <button id="findPackagesByBudgetBtn" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Find Packages</button>
                </div>
                <div id="kwTabContent" class="hidden">
                    <label for="kwSelect" class="block text-sm font-medium text-gray-700">Select System Size</label>
                    <select id="kwSelect" name="kwSelect" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Show All Sizes</option>
                        <option value="3.3">3.3kW</option>
                        <option value="5">5kW</option>
                    </select>
                    <button id="findPackagesByKwBtn" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Find Packages</button>
                </div>
            </div>
        </section>

        <!-- Packages List Section -->
        <section id="packagesSection" class="p-6 md:p-8 hidden">
            <h2 id="packagesTitle" class="text-2xl font-semibold text-gray-800 mb-5 text-center">Available Packages</h2>
            <div id="packagesList" class="space-y-4"></div>
            <div id="noPackagesMessage" class="text-center text-gray-500 py-8 hidden">
                <p class="text-lg">No packages found for your selection.</p>
                <p class="text-sm">Please try a different range or system size.</p>
            </div>
            <button id="startOverBtn" class="w-full mt-6 bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Start Over</button>
        </section>

        <!-- Package Details Section -->
        <section id="detailsSection" class="p-6 md:p-8 hidden">
            <div id="packageDetailContent">
                <h2 id="detail-name" class="text-3xl font-bold text-gray-900 text-center">Package Name</h2>
                <p id="detail-price" class="text-2xl font-semibold text-blue-700 text-center mt-2">Price</p>
                <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3 border-b pb-2">What's Included:</h3>
                <ul id="detail-products" class="list-disc list-inside text-gray-700 space-y-1"></ul>
            </div>
            
            <form id="pdfForm" class="mt-6 mb-4 space-y-3" novalidate>
                <h3 class="text-lg font-semibold text-gray-800">Personalize Your Quotation (Required)</h3>
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="customerName" name="customerName" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., John Doe" required>
                    <span id="nameError" class="text-red-600 text-sm hidden mt-1">This field is required.</span>
                </div>
                <div>
                    <label for="customerAddress" class="block text-sm font-medium text-gray-700">Your Address</label>
                    <textarea id="customerAddress" name="customerAddress" rows="2" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 123 Main St, Colombo" required></textarea>
                    <span id="addressError" class="text-red-600 text-sm hidden mt-1">This field is required.</span>
                </div>
                <div>
                    <label for="customerDiscount" class="block text-sm font-medium text-gray-700">Discount Percentage (Optional)</label>
                    <input type="number" id="customerDiscount" name="customerDiscount" min="0" max="100" step="0.1" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 5">
                </div>
            
                <!-- Status & Manual Upload Area -->
                <div id="statusMessage" class="text-center text-sm text-blue-600 font-medium hidden mb-2"></div>
                
                <div id="manualUploadSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <p class="text-sm text-yellow-800 mb-2">⚠️ Could not automatically fetch the template.</p>
                    <p class="text-xs text-gray-600 mb-3">This happens in preview mode. Please select the "SELTech Quotation.pdf" file from your computer.</p>
                    <input type="file" id="templateUpload" accept=".pdf" class="hidden">
                    <label for="templateUpload" class="cursor-pointer bg-yellow-600 text-white py-2 px-4 rounded-lg text-sm font-bold hover:bg-yellow-700">
                        Select PDF Template
                    </label>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <button id="downloadPdfBtn" type="submit" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center justify-center gap-2">
                        <span id="downloadBtnText">Download as PDF</span>
                        <div id="downloadSpinner" class="spinner hidden"></div>
                    </button>
                    <button id="backBtn" type="button" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Back to List</button>
                </div>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Database of Solar Packages ---
            const allPackages = [
                { id: 1, name: '3.3kW Chinese Package', price: 600000, kw: 3.3, brand: 'Chinese', products: ['10 x 330W Solar Panels (Chinese)', '1 x 3.3kW On-Grid Inverter (Chinese)', 'Standard Mounting Structure', 'DC/AC Cabling & Accessories', 'Installation & Commissioning'] },
                { id: 2, name: '3.3kW Korean Package', price: 850000, kw: 3.3, brand: 'Korean', products: ['8 x 415W Solar Panels (Korean Brand)', '1 x 3.3kW On-Grid Inverter (Korean Brand)', 'Premium Mounting Structure', 'DC/AC Cabling & Accessories', 'Installation & Commissioning'] },
                { id: 3, name: '5kW Chinese Package', price: 900000, kw: 5, brand: 'Chinese', products: ['15 x 330W Solar Panels (Chinese)', '1 x 5kW On-Grid Inverter (Chinese)', 'Standard Mounting Structure', 'DC/AC Cabling & Accessories', 'Installation & Commissioning'] },
                { id: 4, name: '5kW Korean Package', price: 1300000, kw: 5, brand: 'Korean', products: ['12 x 415W Solar Panels (Korean Brand)', '1 x 5kW On-Grid Inverter (Korean Brand)', 'Premium Mounting Structure', 'DC/AC Cabling & Accessories', 'Installation & Commissioning'] }
            ];

            // --- UI Elements ---
            const sections = {
                budget: document.getElementById('budgetSection'),
                packages: document.getElementById('packagesSection'),
                details: document.getElementById('detailsSection')
            };
            
            const btns = {
                findBudget: document.getElementById('findPackagesByBudgetBtn'),
                findKw: document.getElementById('findPackagesByKwBtn'),
                startOver: document.getElementById('startOverBtn'),
                back: document.getElementById('backBtn'),
                download: document.getElementById('downloadPdfBtn'),
                budgetTab: document.getElementById('budgetTabBtn'),
                kwTab: document.getElementById('kwTabBtn')
            };

            const inputs = {
                name: document.getElementById('customerName'),
                address: document.getElementById('customerAddress'),
                discount: document.getElementById('customerDiscount'),
                kwSelect: document.getElementById('kwSelect'),
                templateUpload: document.getElementById('templateUpload')
            };
            
            const ui = {
                status: document.getElementById('statusMessage'),
                manualUpload: document.getElementById('manualUploadSection'),
                downloadText: document.getElementById('downloadBtnText'),
                spinner: document.getElementById('downloadSpinner'),
                pkgList: document.getElementById('packagesList'),
                noPkgMsg: document.getElementById('noPackagesMessage'),
                nameError: document.getElementById('nameError'),
                addrError: document.getElementById('addressError')
            };
            
            let currentSelectedPackage = null;

            // --- Tabs ---
            btns.budgetTab.addEventListener('click', () => {
                btns.budgetTab.classList.add('active'); btns.kwTab.classList.remove('active');
                document.getElementById('budgetTabContent').classList.remove('hidden');
                document.getElementById('kwTabContent').classList.add('hidden');
            });
            btns.kwTab.addEventListener('click', () => {
                btns.kwTab.classList.add('active'); btns.budgetTab.classList.remove('active');
                document.getElementById('kwTabContent').classList.remove('hidden');
                document.getElementById('budgetTabContent').classList.add('hidden');
            });

            // --- Logic ---
            btns.findBudget.addEventListener('click', () => {
                const range = document.querySelector('input[name="budgetRange"]:checked').value;
                const filtered = range === 'all' ? allPackages : allPackages.filter(p => p.price <= parseInt(range));
                displayPackages(filtered);
            });

            btns.findKw.addEventListener('click', () => {
                const val = inputs.kwSelect.value;
                const filtered = val === 'all' ? allPackages : allPackages.filter(p => p.kw === parseFloat(val));
                displayPackages(filtered);
            });

            function displayPackages(packages) {
                ui.pkgList.innerHTML = '';
                if (packages.length === 0) { ui.noPkgMsg.classList.remove('hidden'); }
                else {
                    ui.noPkgMsg.classList.add('hidden');
                    packages.sort((a, b) => a.price - b.price).forEach(pkg => {
                        const div = document.createElement('div');
                        div.className = 'border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-lg transition-shadow duration-300 flex justify-between items-center';
                        div.innerHTML = `<div><h3 class="text-xl font-semibold text-gray-800">${pkg.name}</h3><p class="text-lg font-medium text-blue-700 mt-1">${pkg.price.toLocaleString()}</p></div><button class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">View Details</button>`;
                        div.querySelector('button').addEventListener('click', () => showDetails(pkg));
                        ui.pkgList.appendChild(div);
                    });
                }
                sections.budget.classList.add('hidden'); sections.details.classList.add('hidden'); sections.packages.classList.remove('hidden');
            }

            function showDetails(pkg) {
                currentSelectedPackage = pkg;
                document.getElementById('detail-name').textContent = pkg.name;
                document.getElementById('detail-price').textContent = pkg.price.toLocaleString();
                const list = document.getElementById('detail-products'); list.innerHTML = '';
                pkg.products.forEach(p => { const li = document.createElement('li'); li.textContent = p; list.appendChild(li); });
                sections.packages.classList.add('hidden'); sections.details.classList.remove('hidden');
            }

            function resetUI() {
                sections.details.classList.add('hidden'); sections.packages.classList.add('hidden'); sections.budget.classList.remove('hidden');
                inputs.kwSelect.value = 'all'; document.getElementById('range-all').checked = true;
                inputs.name.value = ''; inputs.address.value = ''; inputs.discount.value = '';
                ui.nameError.classList.add('hidden'); ui.addrError.classList.add('hidden'); ui.status.classList.add('hidden'); ui.manualUpload.classList.add('hidden');
                btns.budgetTab.click();
            }
            
            btns.startOver.addEventListener('click', resetUI);
            btns.back.addEventListener('click', () => { sections.details.classList.add('hidden'); sections.packages.classList.remove('hidden'); ui.status.classList.add('hidden'); ui.manualUpload.classList.add('hidden'); });
            
            // --- File Upload Handler ---
            inputs.templateUpload.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    ui.manualUpload.classList.add('hidden');
                    await processPdf(e.target.files[0].arrayBuffer());
                }
            });

            // --- PDF Generation ---
            async function fetchTemplate() {
                const urls = [
                    'SELTech%20Quotation.pdf', 
                    'public/SELTech%20Quotation.pdf',
                    'https://raw.githubusercontent.com/imeths/SELTech/main/public/SELTech%20Quotation.pdf',
                    'https://raw.githubusercontent.com/imeths/SELTech/main/SELTech%20Quotation.pdf' // Added root fallback
                ];
                
                for (const url of urls) {
                    try {
                        const res = await fetch(url);
                        if (res.ok) return await res.arrayBuffer();
                    } catch (e) { console.warn('Fetch failed:', url); }
                }
                return null; // Failed all
            }

            document.getElementById('pdfForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                let valid = true;
                if (!inputs.name.value.trim()) { ui.nameError.classList.remove('hidden'); valid = false; } else ui.nameError.classList.add('hidden');
                if (!inputs.address.value.trim()) { ui.addrError.classList.remove('hidden'); valid = false; } else ui.addrError.classList.add('hidden');
                if (!valid) return;

                btns.download.disabled = true; ui.downloadText.textContent = 'Checking Template...'; ui.spinner.classList.remove('hidden');
                ui.status.classList.remove('hidden'); ui.status.textContent = 'Looking for PDF template...';

                // 1. Try Auto Fetch
                let templateBuffer = await fetchTemplate();
                
                if (templateBuffer) {
                     await processPdf(templateBuffer);
                } else {
                    // 2. Fail -> Show Manual Upload
                    ui.status.textContent = 'Template not found automatically.';
                    ui.status.classList.add('text-yellow-600');
                    ui.manualUpload.classList.remove('hidden');
                    ui.downloadText.textContent = 'Download as PDF';
                    ui.spinner.classList.add('hidden');
                    btns.download.disabled = false;
                }
            });

            async function processPdf(templateBuffer) {
                ui.status.classList.remove('text-yellow-600');
                ui.status.classList.add('text-blue-600');
                ui.status.textContent = 'Generating Quote...';
                ui.downloadText.textContent = 'Merging...';
                btns.download.disabled = true; // Ensure disabled during processing

                try {
                    // Resolve the promise to get the ArrayBuffer
                    const buffer = templateBuffer instanceof Promise ? await templateBuffer : templateBuffer;

                    const { PDFDocument } = window.PDFLib;
                    const pdfDoc = await PDFDocument.create();
                    const templateDoc = await PDFDocument.load(buffer);
                    
                    // Generate Quote Page
                    const quoteBytes = await createQuotePage();
                    const quoteDoc = await PDFDocument.load(quoteBytes);

                    // Merge Logic (Pages 1-6, Quote, Pages 7-10)
                    const p1 = await pdfDoc.copyPages(templateDoc, [0,1,2,3,4,5]);
                    p1.forEach(p => pdfDoc.addPage(p));
                    
                    const [qPage] = await pdfDoc.copyPages(quoteDoc, [0]);
                    pdfDoc.addPage(qPage);
                    
                    const p2 = await pdfDoc.copyPages(templateDoc, [6,7,8,9]);
                    p2.forEach(p => pdfDoc.addPage(p));

                    const pdfBytes = await pdfDoc.save();
                    
                    // Download
                    const name = inputs.name.value.trim().replace(/ /g, '_');
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${name}_SELTech_${currentSelectedPackage.kw}kW_Quotation.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    ui.status.textContent = 'Download Started!';
                    setTimeout(() => { ui.status.classList.add('hidden'); }, 3000);

                } catch (err) {
                    console.error(err);
                    alert('Error generating PDF: ' + err.message);
                    ui.status.textContent = 'Error occurred.';
                } finally {
                    ui.downloadText.textContent = 'Download as PDF';
                    ui.spinner.classList.add('hidden');
                    btns.download.disabled = false;
                }
            }

            async function createQuotePage() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const w = doc.internal.pageSize.getWidth();
                const h = doc.internal.pageSize.getHeight();
                const margin = 20;
                let y = margin;

                // Logo
                try {
                    const imgRes = await fetch('https://i.postimg.cc/KvgCmtJG/SELTech-Logo-App.png');
                    if(imgRes.ok) {
                        const imgBuf = await imgRes.arrayBuffer();
                        doc.addImage(new Uint8Array(imgBuf), 'PNG', margin, y, 30, 30);
                    }
                } catch(e) { 
                    doc.setFillColor(200); doc.rect(margin, y, 30, 30, 'F'); doc.text("Logo", margin+5, y+15);
                }

                // Header Info
                doc.setFontSize(10); doc.setTextColor(80);
                doc.text('SELTech International', w-margin, y+5, {align:'right'});
                doc.text('30, Pepiliyana Rd, Nugegoda', w-margin, y+10, {align:'right'});
                doc.text('011 273 9933 / 077 731 5605', w-margin, y+15, {align:'right'});

                y = 60;
                doc.setFontSize(12); doc.setFont('helvetica','bold');
                doc.text('PREPARED FOR:', margin, y);
                y += 6; doc.setFont('helvetica','normal'); doc.setTextColor(20);
                doc.text(inputs.name.value.trim(), margin, y);
                y += 6; 
                const addrLines = doc.splitTextToSize(inputs.address.value.trim(), 80);
                doc.text(addrLines, margin, y);
                y += (addrLines.length * 6) + 10;

                doc.setFontSize(22); doc.setFont('helvetica','bold'); doc.setTextColor(30,58,138);
                doc.text('Solar Package Quotation', margin, y);
                y += 8; doc.setFontSize(12); doc.setFont('helvetica','normal'); doc.setTextColor(50);
                doc.text(`Date Issued: ${new Date().toLocaleDateString()}`, margin, y);
                y += 15;

                // Pricing Box
                const price = currentSelectedPackage.price;
                const discount = parseFloat(inputs.discount.value) || 0;
                const discountVal = (price * discount) / 100;
                const finalVal = price - discountVal;

                let lines = [
                    {l: 'Package Price:', v: price.toLocaleString()},
                ];
                if(discount > 0) {
                    lines.push({l: `Discount (${discount}%):`, v: `- ${discountVal.toLocaleString()}`});
                    lines.push({l: 'Final Price:', v: finalVal.toLocaleString(), bold: true});
                } else {
                    lines.push({l: 'Total Price:', v: finalVal.toLocaleString(), bold: true});
                }
                
                const boxH = 22 + (lines.length * 7);
                doc.setFillColor(249,250,251); doc.setDrawColor(229,231,235);
                doc.roundedRect(margin, y, w-(margin*2), boxH, 3, 3, 'FD');
                
                doc.setFontSize(14); doc.setFont('helvetica','bold'); doc.setTextColor(20);
                doc.text(currentSelectedPackage.name, margin+10, y+10);
                doc.setFontSize(11); doc.setFont('helvetica','normal'); doc.setTextColor(80);
                doc.text(`System Size: ${currentSelectedPackage.kw} kW`, margin+10, y+18);

                let py = y+10;
                lines.forEach(l => {
                    doc.setFont('helvetica', l.bold ? 'bold' : 'normal');
                    doc.setFontSize(l.bold ? 14 : 11);
                    doc.setTextColor(l.bold ? 30 : 80, l.bold ? 58 : 80, l.bold ? 138 : 80);
                    doc.text(l.l, w-margin-65, py, {align:'left'});
                    doc.text(l.v, w-margin-10, py, {align:'right'});
                    py += 7;
                });

                y += boxH + 10;

                doc.setFontSize(14); doc.setFont('helvetica','bold'); doc.setTextColor(50);
                doc.text('Products Included', margin, y);
                y += 8; doc.setFontSize(11); doc.setFont('helvetica','normal'); doc.setTextColor(20);
                
                currentSelectedPackage.products.forEach(p => {
                    if(y > h - margin) { doc.addPage(); y = margin; }
                    doc.text('•', margin+5, y);
                    const pl = doc.splitTextToSize(p, w-(margin*2)-15);
                    doc.text(pl, margin+10, y);
                    y += (pl.length * 6) + 2;
                });

                const fy = h - 15;
                doc.setFontSize(10); doc.setTextColor(150);
                doc.line(margin, fy-5, w-margin, fy-5);
                doc.text('Thank you for choosing SELTech International.', w/2, fy, {align:'center'});

                return doc.output('arraybuffer');
            }
        });
    </script>
</body>
</html>